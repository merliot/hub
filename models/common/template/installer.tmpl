// Autogenerated from installer.tmpl

package main

import (
	"embed"
	"flag"
	"fmt"
	"io"
	"os"
	"os/exec"
	"os/user"
)

//go:embed {{.model}} {{.model}}.service {{.model}}.conf
var fs embed.FS

func removeLogging() {
	fmt.Println("Removing logging for {{.model}}...")
	os.Remove("/etc/rsyslog.d/{{.model}}.conf")
	exec.Command("systemctl", "restart", "rsyslog.service").Run()
}

func removeService() {
	fmt.Println("Removing systemd service for {{.model}}...")
	exec.Command("systemctl", "stop", "{{.model}}").Run()
	exec.Command("systemctl", "disable", "{{.model}}").Run()
	os.Remove("/lib/systemd/system/{{.model}}.service")
	exec.Command("systemctl", "daemon-reload").Run()
}

func removemodel() {
	fmt.Println("Removing {{.model}}...")
	os.Remove("/usr/local/bin/{{.model}}")
}

func installFile(srcName, dstName string, mode os.FileMode) {
	exec.Command("systemctl", "stop", "{{.model}}").Run()

	src, err := fs.Open(srcName)
	if err != nil {
		panic(err.Error())
	}
	defer src.Close()

	dst, err := os.Create(dstName)
	if err != nil {
		panic(err.Error())
	}
	defer dst.Close()

	_, err = io.Copy(dst, src)
	if err != nil {
		panic(err.Error())
	}

	if err := os.Chmod(dstName, mode); err != nil {
		panic(err.Error())
	}
}

func installmodel() {
	fmt.Println("Intalling {{.model}}...")
	installFile("{{.model}}", "/usr/local/bin/{{.model}}", 0755)
}

func installLogging() {

	fmt.Println("Intalling logging for {{.model}}...")

	if _, err := os.Stat("/etc/rsyslog.d"); os.IsNotExist(err) {
		panic(fmt.Errorf("Failed: rsyslog is not installed; install with 'sudo apt install rsyslog'."))
	}

	installFile("{{.model}}.conf", "/etc/rsyslog.d/{{.model}}.conf", 0644)

	cmd := exec.Command("systemctl", "restart", "rsyslog.service")
	stdoutStderr, err := cmd.CombinedOutput()
	if err != nil {
		panic(fmt.Errorf("%w: %s", err, stdoutStderr))
	}
}

func installService() {

	fmt.Println("Intalling systemd service for {{.model}}...")
	installFile("{{.model}}.service", "/lib/systemd/system/{{.model}}.service", 0644)

	cmd := exec.Command("systemctl", "daemon-reload")
	stdoutStderr, err := cmd.CombinedOutput()
	if err != nil {
		panic(fmt.Errorf("%w: %s", err, stdoutStderr))
	}

	cmd = exec.Command("systemctl", "enable", "{{.model}}")
	stdoutStderr, err = cmd.CombinedOutput()
	if err != nil {
		panic(fmt.Errorf("%w: %s", err, stdoutStderr))
	}

	cmd = exec.Command("systemctl", "restart", "{{.model}}")
	stdoutStderr, err = cmd.CombinedOutput()
	if err != nil {
		panic(fmt.Errorf("%w: %s", err, stdoutStderr))
	}
}

func main() {

	remove := flag.Bool("u", false, "Uninstall {{.model}}")
	flag.Parse()

	user, _ := user.Current()
	if user.Username != "root" {
		fmt.Println("Installer must be run as root.")
		return
	}


	if *remove {
		removeLogging()
		removeService()
		removemodel()
	} else {
		installmodel()
		installLogging()
		installService()
	}
	fmt.Println("Success!")
}
